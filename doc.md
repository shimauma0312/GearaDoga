## **PythonとMT5を用いた自動売買スクリプトの作成方法**

PythonとMT5を連携させて自動売買スクリプトを作成するには、以下の手順を踏みます。

### **1\. MT5のAPIの使い方**

MT5は、Pythonから制御するためのAPIを提供しています。MetaTrader5というPythonライブラリをインストールすることで、このAPIにアクセスできます。このAPIを通じて、PythonからMT5の口座情報、市場データ、注文などの操作を行うことができます。

MT5のチャート上のデータを取得するには、copy\_rates\_from()、copy\_rates\_from\_pos()、copy\_rates\_range() の3つの関数が用意されています。 copy\_rates\_from() は開始時刻とバーの個数を指定し、copy\_rates\_from\_pos() は開始するバーの位置とバーの個数を指定、copy\_rates\_range() は開始時刻と終了時刻を指定してデータを取得します。

Python

`import MetaTrader5 as mt5`

`# MT5に接続`  
`if not mt5.initialize(login=<ログインID>, server=<サーバー名>, password=<パスワード>):`  
    `print("initialize() failed, error code =", mt5.last_error())`  
    `quit()`

`# 銘柄情報を取得`  
`symbol_info = mt5.symbol_info("EURUSD")`  
`print(symbol_info)`

`# EURUSDの1時間足データを取得 (開始時刻とバーの個数を指定)`  
`bars = mt5.copy_rates_from("EURUSD", mt5.TIMEFRAME_H1, datetime(2023, 1, 1), 1000)`

`# MT5との接続を切断`  
`mt5.shutdown()`

Phillip Co.jp のナレッジベースでは、MT5とPythonの連携に関する詳細な情報が提供されています。

### **2\. 売買シグナルの生成方法**

売買シグナルは、テクニカル指標や価格変動パターンなどを分析して生成します。例えば、移動平均線のゴールデンクロス/デッドクロス、RSI、ボリンジャーバンドなどの指標を用いることができます。Pythonのライブラリを活用することで、これらの指標を簡単に計算し、売買シグナルを生成できます。

Python

`import MetaTrader5 as mt5`  
`import pandas as pd`

`# ... MT5への接続処理 ...`

`# EURUSDの1時間足データを取得`  
`bars = mt5.copy_rates_from_pos("EURUSD", mt5.TIMEFRAME_H1, 0, 1000)`  
`df = pd.DataFrame(bars)`  
`df['time'] = pd.to_datetime(df['time'], unit='s')`

`# 移動平均線を計算`  
`df['sma5'] = df['close'].rolling(window=5).mean()`  
`df['sma20'] = df['close'].rolling(window=20).mean()`

`# ゴールデンクロス/デッドクロスを判定`  
`df['signal'] = 0.0`  
`df['signal'][df['sma5'] > df['sma20']] = 1.0  # 買いシグナル`  
`df['signal'][df['sma5'] < df['sma20']] = -1.0 # 売りシグナル`

`# ... MT5との接続切断処理 ...`

### **3\. 注文の実行方法**

売買シグナルに基づいて、PythonからMT5に注文を出します。 mt5.order\_send() 関数を使用することで、様々な種類の注文を実行できます。注文を出す際には、銘柄、数量、注文の種類、価格などを指定します。

MT5では、成行注文、指値注文、逆指値注文など、様々な注文方法が用意されています。

* **成行注文**: 現在の市場価格で即座に約定させる注文です。  
* **指値注文**: 指定した価格以下（買い注文の場合）または以上（売り注文の場合）で約定させる注文です。  
* **逆指値注文**: 指定した価格以上（買い注文の場合）または以下（売り注文の場合）で約定させる注文です。

注文の種類に応じて、mt5.order\_send() 関数に渡すパラメータが異なります。

また、orders\_total を使用することで、現在待機中の注文数にアクセスすることもできます。

Python

`import MetaTrader5 as mt5`

`# ... MT5への接続処理 ...`

`# 買い注文のリクエストを作成`  
`request = {`  
    `"action": mt5.TRADE_ACTION_DEAL,`  
    `"symbol": "EURUSD",`  
    `"volume": 0.1,`  
    `"type": mt5.ORDER_TYPE_BUY,`  
    `"price": mt5.symbol_info_tick("EURUSD").ask,`  
    `"sl": mt5.symbol_info_tick("EURUSD").ask - 10 * mt5.symbol_info("EURUSD").point,`  
    `"tp": mt5.symbol_info_tick("EURUSD").ask + 20 * mt5.symbol_info("EURUSD").point,`  
    `"deviation": 20,`  
    `"magic": 234000,`  
    `"comment": "python script open",`  
    `"type_time": mt5.ORDER_TIME_GTC,`  
    `"type_filling": mt5.ORDER_FILLING_IOC,`  
`}`

`# 注文を送信`  
`result = mt5.order_send(request)`  
`print("1. order_send(): by {} {} lots at {} with deviation={} points".format(symbol, volume, price, deviation))`  
`if result.retcode != mt5.TRADE_RETCODE_DONE:`  
    `print("2. order_send failed, retcode={}".format(result.retcode))`  
    `# 結果をリクエスト辞書とエラーコードとともに表示する`  
    `result_dict=result._asdict()`  
    `for field in result_dict.keys():`  
        `print("   {}={}".format(field,result_dict))`  
        `# 特定のエラーの場合、取引リクエストを再送信する必要があるかどうかを確認する`  
        `if field=="request":`  
            `traderequest_dict=result_dict._asdict()`  
            `for tradereq_field in traderequest_dict:`  
                `print("       traderequest: {}={}".format(tradereq_field,traderequest_dict))`  
    `print("shutdown() and quit")`  
    `mt5.shutdown()`  
    `quit()`

`print("2. order_send done, ", result)`  
`print("   opened position with POSITION_TICKET={}".format(result.order))`  
`print("   shutdown() and quit")`  
`mt5.shutdown()`

`# ... MT5との接続切断処理 ...`

### **4\. バックテストの実施方法**

作成した自動売買スクリプトは、過去のデータを用いてバックテストを行い、その性能を評価します。MT5には、ストラテジーテスターというバックテスト機能が備わっています。バックテストでは、取引期間、通貨ペア、時間足、初期資金などを設定し、シミュレーションを行います。バックテストの結果は、損益、勝率、最大ドローダウンなどの指標で評価します。

### **5\. リスク管理の方法**

自動売買では、損失を最小限に抑えるためのリスク管理が重要です。具体的な方法としては、ストップロス注文の設定、ポジションサイズのコントロール、取引頻度の制限などが挙げられます。また、複数の通貨ペアや戦略に分散投資することで、リスクを軽減することも有効です。

取引頻度を制限することで、過剰な取引による手数料の増加や、不利な価格での約定を防ぐことができます。1日の最大取引回数や、1時間あたりの取引回数を制限するなどの方法があります。

## **自動売買スクリプトの運用方法**

自動売買スクリプトを実際に運用する際には、以下の点に注意する必要があります。

### **1\. VPSの利用**

自動売買スクリプトを安定稼働させるためには、VPS（仮想専用サーバー）の利用が推奨されます。VPSは、24時間365日稼働し、安定したネットワーク環境を提供するため、自宅のPCで運用するよりもリスクを軽減できます。特に、FX会社が提供するVPSサービスを利用することで、取引サーバーとの通信遅延を最小限に抑えられます。

| Provider | Monthly Cost | Memory | Network | CPU | Storage | OS |
| :---- | :---- | :---- | :---- | :---- | :---- | :---- |
| シンクラウドデスクトップ for FX | 1,320円 | 2GB | 10Gbps | 2コア | SSD150GB | Windows Server 2022 |
| ABLENET 仮想デスクトッププラン | 2,907円 | 2GB | 200Mbps | 2コア | SSD60GB | Windows Server 2022 |
| WebARENA Indigo | 2,707円 | 2GB | 100Mbps | 3コア | SSD100GB | Windows Server 2022 |

### **2\. モニタリング**

自動売買システムは、定期的にモニタリングし、パフォーマンスや動作状況を確認する必要があります。特に、市場環境が大きく変化した場合には、パラメータの調整や戦略の見直しが必要となることがあります。

MT5では、すでに様々な方法で情報を見ることができますが、正確に予測して正しく注文を実行しているかどうかを知りたいと思うことがあります。これらの行動を追跡し、実際のチャートと予測を比較するために、チャートと関連情報をTelegramのボットに送信することもできます。

### **3\. パフォーマンスの評価**

自動売買システムのパフォーマンスは、損益、勝率、最大ドローダウン、Sharpe Ratioなどの指標で評価します。これらの指標を定期的に分析することで、システムの改善点を特定することができます。

MT5のバックテストでは、以下の指標を確認することができます。

* 総損益: すべての取引の損益の合計です。  
* 残高（証拠金）最大ドローダウン: 一定期間における残高（または証拠金）の最大値からの下落幅です。  
* プロフィットファクター: 勝ちトレードの利益の合計を負けトレードの損失の合計で割った値です。  
* リカバリーファクター: 総損益を最大ドローダウンで割った値です。  
* 期待利得: 1トレードあたりの平均的な損益です。  
* 取引数: トレードの回数です。  
* ショート（ロング）: ショートポジションとロングポジションのそれぞれの取引数です。  
* 勝ちトレード（負けトレード）: 勝ちトレードと負けトレードのそれぞれの回数です。

### **4\. メンテナンス**

自動売買スクリプトは、定期的にメンテナンスを行う必要があります。MT5やPythonのバージョンアップに対応したり、バグ修正や機能追加を行うことで、システムの安定稼働を維持できます。

## **機械学習あるいはディープラーニングでのテクニカル分析の実装方法**

機械学習やディープラーニングをテクニカル分析に活用することで、より高度な売買シグナルを生成できます。

### **1\. データの前処理**

機械学習やディープラーニングでは、データの前処理が非常に重要です。欠損値の処理、ノイズの除去、正規化などを行い、モデルの学習に適したデータに変換します。Pythonのライブラリ (pandas, scikit-learn など) を活用することで、効率的に前処理を行うことができます。

数値データの場合、異なるフォーマットのデータを組み合わせる場合や、データ項目の一部が欠落している場合に、ディープラーニングがデータ処理できるように異常値、文字列、欠損のデータ部分の加工や除去を行います。

### **2\. モデルの構築**

適切な機械学習モデルやディープラーニングモデルを選択します。例えば、価格予測には回帰モデル、売買シグナルの生成には分類モデルなどが用いられます。 scikit-learn や TensorFlow などのライブラリを利用することで、様々なモデルを簡単に構築できます。

### **3\. モデルの評価**

構築したモデルは、テストデータを用いて評価します。正解率、適合率、再現率、F値などの指標を用いて、モデルの性能を測定します。また、過学習やバイアスなどの問題がないかを確認します。

深層学習はパラメータ数が多くモデルが大規模になるため、学習データ以外の入力に対する判断性能（汎化性能）が低下しやすいというデメリットがあります。これを過学習といいます。過学習を防ぐためには、モデルの複雑さを調整したり、正則化と呼ばれる手法を用いたりするなどの対策が必要です。

### **4\. モデルのデプロイ**

評価が完了したモデルは、実際の取引に利用するためにデプロイします。VPS上にモデルを配置し、APIなどを 통해 Pythonスクリプトからアクセスできるようにします。モデルのバージョン管理や更新なども考慮する必要があります。

深層学習モデルの開発では、大きな計算リソースが必要となる場合があります。このような場合は、パブリッククラウドを利用することで、GPUなどの計算資源を柔軟に利用することができます。また、クラウドベンダ各社が提供する機械学習プラットフォームサービスを利用することで、開発環境の構築やモデルのデプロイを効率化することもできます。

## **自動売買のリスク**

自動売買は、システムの不具合や市場の急変などにより、損失が発生するリスクがあります。また、過剰な最適化やパラメータ設定のミスなど、人為的なミスも損失に繋がりかねません。そのため、自動売買を行う際には、リスクを十分に理解し、適切なリスク管理を行うことが重要です。

インターネット上で公開されている無料または有料のEAを使用する場合、そのEAがすべての市場状況において有効であるとは限らないことに注意が必要です。また、EAの開発者が意図したとおりに動作しない可能性もあります。

## **自動売買の法的規制**

自動売買を行う際には、各国の法律や規制を遵守する必要があります。特に、金融商品取引法や金融サービス法などの規制に注意が必要です。

## **自動売買の倫理的な問題**

自動売買システムが、市場を混乱させたり、不公正な取引を行ったりする可能性も懸念されています。そのため、倫理的な観点からも、自動売買システムの開発・運用には注意が必要です。

